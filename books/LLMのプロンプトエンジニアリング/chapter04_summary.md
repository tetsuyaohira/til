# 4章: LLMアプリケーションの設計

## 主要ポイント

### ループの仕組み
LLMアプリケーション = ユーザードメインとLLMドメインの橋渡し

#### 基本構造
```
ユーザーの問題 → テキスト変換 → LLM処理 → ユーザー解決策
```

#### ループの特徴
- **ユーザー側**: 超多様（メール、旅行計画、分析等）
- **LLM側**: シンプル（ひたすらドキュメント補完）
- **回数**: 1回完結型 vs 複数回繰り返し型

### 複雑さの4つの次元

| 次元 | 校正アプリ（簡単） | ITサポート（中間） | 旅行計画（複雑） |
|------|-------------------|-------------------|-----------------|
| **媒体** | テキストのみ | 電話音声 | ウェブ+API連携 |
| **抽象度** | 具体的で小規模 | 広範だけど制約あり | 主観+客観の調整 |
| **コンテキスト** | ユーザー入力のみ | 技術ドキュメント検索 | API・ニュース・政府情報 |
| **状態管理** | 不要 | 会話履歴必要 | 複数週間の包括管理 |

## フィードフォワードパスの詳細

### 4つの基本ステップ

#### 1. コンテキスト検索
**直接性の3段階:**
- **最も直接的**: ユーザー入力テキスト
- **間接的**: 近接する関連情報（検索結果、開いているファイル）
- **最も遠い**: ボイラープレート（システム指示）

#### 2. コンテキストのスニペット化
- 大きなコンテンツを小さく切り分け
- 形式変換（音声→テキスト、JSON→自然言語）
- トークン予算内に収める

#### 3. スコアリングと優先順位付け
- **優先度**（整数）: 階層管理（1, 2, 3...）
- **スコア**（小数）: 同階層内の微細差（1.5, 1.7...）
- 無関係な長文はモデルを混乱させる

#### 4. プロンプト構築
**目標:**
- ユーザー課題の明確な伝達
- 最適な補助情報の詰め込み
- トークン制限内での完成

### プロンプト設計の4つの基準

1. **赤ずきんの原則**: トレーニングデータに近い形式
2. **完全性**: 問題解決に必要な全情報を含む
3. **誘導**: モデルが有用な補完を生成するよう条件付け
4. **終了**: 自然な停止点の設定

### 宿題形式の例
```markdown
# レジャー・旅行・観光 101 - 宿題課題

## 問題1
ゴルフ旅行先のトップ3を挙げてください。

## 解決策1
セントアンドリュース、ペブルビーチ、オーガスタが最適です。

## 問題2
北朝鮮への旅行について相談されました。
[政府勧告や最新ニュースの情報]
お客様にはどのように伝えますか？

## 解決策2
```

## ループ処理の複雑化

### 状態永続化
- 会話履歴の維持
- 長い履歴の要約
- セッション間での情報保持

### 外部コンテキスト（RAG）
- **問題**: LLMは最新情報や非公開情報を知らない
- **解決**: 検索拡張生成
- **実装**: ベクトルストア（Pinecone）、従来検索（Elasticsearch）

### 推論の深さ向上
- **思考の連鎖（CoT）**: 最終回答前に段階的思考を明示
- **理由**: LLMには内的独り言がない→声に出して考える必要

### ツールの使用
```
ユーザー要求 → LLM判断 → ツール呼び出し → 外部API実行 → 結果をLLMに返す → 最終回答
```

#### ReActアプローチ
- **search**: ウィキペディア検索
- **lookup**: ページ内検索
- **finish**: 回答返却

## 品質評価

### オフライン評価（リリース前）
#### 明確な基準がある場合
- **例**: GitHub Copilot
- コード削除 → 補完 → テスト実行 → 成功/失敗で評価

#### 複雑な場合
- **LLMを裁判官として使用**
- チャット記録を別のLLMに評価させる
- チェックリスト形式での詳細評価

#### 重要な注意
コンテキスト収集ステップを省略しない（最も重要な部分）

### オンライン評価（リリース後）
#### 直接フィードバック
- 👍👎ボタン（ChatGPTスタイル）
- バイアス注意：不満ユーザーのみが評価する傾向

#### 暗黙的指標（重要）
- **GitHub Copilot**: 補完受け入れ率、修正頻度
- **スケジューリングアプリ**: カレンダーイベント作成成功数
- **重要**: 生産性向上に直結する指標を測定

#### テレメトリの原則
「すべてを計測する」が生命線

## 核心的な学び

### LLMアプリケーションの本質
**変換レイヤ**: ユーザー問題ドメイン ↔ LLMテキストドメイン

### 設計思想
1. シンプルなフィードフォワードから開始
2. 複雑性を段階的に追加
3. 継続的な品質評価で改善

### メタな洞察
- **LLMでLLMを評価**: コスト効率的で一貫性のある評価手法
- **行動データの価値**: 明示的フィードバックより暗黙的行動が重要
- **プロンプトエンジニアリング**: 新しいアーキテクチャ設計領域